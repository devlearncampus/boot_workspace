<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <h2>Spring WebSocket 기반 채팅 </h2>

        <!--DB 연동하지 않고, 사용자를 직접 입력하여 채팅진행 -->
        <div v-if="!connected">
            <input type="text" v-model="username" placeholder="채팅 사용자명 입력">
            <button type="button" @click="connect()">웹소켓서버 접속</button>
        </div>
        <div v-else>
            <p><b>{{username}}</b>님 접속중</p>
            <button type="button" @click="disconnect()">접속종료</button>

            <div>
                <input type="text" v-model="message" @keyup.enter="sendMessage()" placeholder="메시지를 입력하세요">
                <button type="button" @click="sendMessage()">메시지 전송</button>
            </div>
        </div>

        <h3>총 접속자</h3>
        <ul>
            <li v-for="user in users"></li>
        </ul>
    </div>


    <script>
        const {createApp, ref} =Vue;

        createApp({
            setup(){
                const username = ref("");//사용자명 바인딩 변수
                const connected = ref(false); //접속 여부 판단
                const message = ref(""); //입력중인 채팅 메시지
                const users=ref([]); //전체 접속자 목록

                let socket=null;

                /*----------------------------------------
                 접속: 서버와 연결
                ----------------------------------------*/
                const connect=()=>{
                    if(!username.value.trim()){
                        alert("이름을 입력하세요");
                        return;
                    }

                    //서버와 WebSocket 연결 시도
                    socket = new WebSocket("ws://localhost:9999/ws");

                    //onopen 호출되었다는 것은 성공했다는 것임
                    socket.onopen = () => {
                        //성공을 보장한 코드이므로  바인딩 변수 connected=true로 놓자 , 디자인 자동 반영
                        connected.value = true;
                    }

                    //서버로부터 메시지를 받을때 실행되는 콜백
                    socket.onmessage = (event)=>{

                    }
                }

                /*----------------------------------------
                 채팅 메시지 보내기
                ----------------------------------------*/
                const send = (payload)=>{
                    socket.send(JSON.stringify(payload));
                }


                /*----------------------------------------
                 채팅 메시지 보내기
                ----------------------------------------*/
                const sendMessage = () => {
                    //메시지가 비어있지 않을 경우만, 서버에 전송
                    if(message.value.trim()){
                        send({
                            type:"MESSAGE",
                            sender:username.value,
                            content:message.value
                        });
                        message.value = ""; //입력값 초기화
                    }
                }


                /*----------------------------------------
                 접속해제
                ----------------------------------------*/
                const disconnect = () => {
                    //서버에 '나 접속 끊을게' 알리기
                    socket.close();
                }

                return {username, connected, connect,message,users, sendMessage, disconnect};
            }
        }).mount("#app");
    </script>


</body>
</html>